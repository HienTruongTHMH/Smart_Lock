<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Lock Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-indigo-800 mb-8">üîê Smart Lock Management</h1>
        
        <!-- Main Menu -->
        <div id="mainMenu" class="bg-white rounded-lg shadow-lg p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="showUserList()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üë• Danh s√°ch ng∆∞·ªùi d√πng
                </button>
                <button onclick="showAccessLog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üìä L·ªãch s·ª≠ ra v√†o
                </button>
                <button onclick="showRegistration()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    ‚ûï ƒêƒÉng k√Ω ng∆∞·ªùi d√πng m·ªõi
                </button>
                <button onclick="showAddCard()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üé´ Th√™m th·∫ª RFID
                </button>
            </div>
            
            <!-- Test Database Connection -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="testDatabaseConnection()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    üîó Test Database Connection
                </button>
                <div id="connectionResult" class="mt-2 text-sm"></div>
            </div>
        </div>

        <!-- User List -->
        <div id="userList" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üë• Danh s√°ch ng∆∞·ªùi d√πng</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            <div id="userListContent">Loading...</div>
        </div>

        <!-- Access Log -->
        <div id="accessLog" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üìä L·ªãch s·ª≠ ra v√†o</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            <div id="accessLogContent">Loading...</div>
        </div>

        <!-- Registration -->
        <div id="registration" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">‚ûï ƒêƒÉng k√Ω ng∆∞·ªùi d√πng m·ªõi</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒë·∫ßy ƒë·ªß (t√πy ch·ªçn)</label>
                    <input type="text" id="fullName" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o t√™n" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button onclick="startRegistration()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">
                    üöÄ B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω
                </button>
            </div>
        </div>

        <!-- Registration Status -->
        <div id="registrationStatus" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-2" id="statusMessage">ƒêang kh·ªüi t·∫°o...</h3>
                <p class="text-gray-600 mb-4" id="statusDetail">Vui l√≤ng ch·ªù...</p>
                <button onclick="cancelRegistration()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    ‚ùå H·ªßy ƒëƒÉng k√Ω
                </button>
            </div>
        </div>

        <!-- Add Card -->
        <div id="addCard" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üé´ Th√™m th·∫ª RFID</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn ng∆∞·ªùi d√πng</label>
                    <select id="userSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <button onclick="startAddCard()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg">
                    üé´ B·∫Øt ƒë·∫ßu th√™m th·∫ª
                </button>
            </div>
        </div>

        <!-- Add Card Status -->
        <div id="addCardStatus" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-2">Ch·ªù qu√©t th·∫ª RFID</h3>
                <p class="text-gray-600 mb-4">ƒê·∫∑t th·∫ª RFID l√™n ESP32 ƒë·ªÉ qu√©t...</p>
                <button onclick="cancelAddCard()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    ‚ùå H·ªßy th√™m th·∫ª
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://api-i6f5axhif-hiens-projects-d1689d2e.vercel.app"; // T·ª± ƒë·ªông detect domain hi·ªán t·∫°i
        const SMART_LOCK_API = API_BASE + '/api/smart-lock';
        const ADMIN_API = API_BASE + '/api/admin';

        let registrationTimer = null;
        let addCardTimer = null;

        // =================== NAVIGATION ===================
        function showMainMenu() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('mainMenu').classList.remove('hidden');
        }

        function showUserList() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('userList').classList.remove('hidden');
            loadUserList();
        }

        function showAccessLog() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('accessLog').classList.remove('hidden');
            loadAccessLog();
        }

        function showRegistration() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('registration').classList.remove('hidden');
        }

        function showAddCard() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('addCard').classList.remove('hidden');
            loadUsersWithoutCards();
        }

        // =================== DATABASE TEST ===================
        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = 'üîÑ Testing connection...';
            
            try {
                // ‚úÖ S·ª¨A: D√πng SMART_LOCK_API v·ªõi action=test_connection
                const response = await fetch(`${SMART_LOCK_API}?action=test_connection`);
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="text-green-600">
                            ‚úÖ Database connected successfully!<br>
                            <small>Time: ${new Date(data.timestamp).toLocaleString()}</small><br>
                            <small>PostgreSQL: ${data.pgVersion}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="text-red-600">‚ùå Connection failed: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Database test error:', error);
                resultDiv.innerHTML = `<div class="text-red-600">‚ùå Connection error: ${error.message}</div>`;
            }
        }

        // =================== USER LIST ===================
        async function loadUserList() {
            try {
                // ‚úÖ S·ª¨A: D√πng SMART_LOCK_API v·ªõi action=get_users
                const response = await fetch(`${SMART_LOCK_API}?action=get_users`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    const content = document.getElementById('userListContent');
                    content.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4">Danh s√°ch ng∆∞·ªùi d√πng (${data.users.length})</h3>
                        <div class="space-y-2">
                            ${data.users.map(user => `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium">${user.name}</div>
                                            <div class="text-sm text-gray-600">
                                                ID: ${user.id} | 
                                                ${user.uid 
                                                    ? `üé´ Th·∫ª: ${user.uid}` 
                                                    : `üìù Ch∆∞a c√≥ th·∫ª RFID`
                                                } |
                                                ${user.hasPassword ? 'üîë C√≥ m·∫≠t kh·∫©u' : '‚ùå Ch∆∞a c√≥ m·∫≠t kh·∫©u'}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                T·∫°o: ${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}
                                            </div>
                                        </div>
                                        ${!user.uid ? `
                                            <button onclick="addCard(${user.id}, '${user.name}')" 
                                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                                + Th√™m th·∫ª
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('userListContent').innerHTML = 
                        `<p class="text-red-600">L·ªói t·∫£i danh s√°ch: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error loading user list:', error);
                document.getElementById('userListContent').innerHTML = 
                    `<p class="text-red-600">L·ªói k·∫øt n·ªëi: ${error.message}</p>`;
            }
        }

        // =================== ACCESS LOG ===================
        async function loadAccessLog() {
            try {
                // ‚úÖ S·ª¨A: D√πng SMART_LOCK_API v·ªõi action=get_access_log
                const response = await fetch(`${SMART_LOCK_API}?action=get_access_log&limit=30`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (data.success) {
                    const content = document.getElementById('accessLogContent');
                    
                    if (data.logs.length === 0) {
                        content.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ truy c·∫≠p n√†o.</p>';
                        return;
                    }
                    
                    content.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4">L·ªãch s·ª≠ truy c·∫≠p (${data.logs.length})</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${data.logs.map(log => `
                                <div class="bg-gray-50 p-3 rounded-lg border-l-4 ${log.success ? 'border-green-500' : 'border-red-500'}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium">
                                                ${log.success ? '‚úÖ' : '‚ùå'} ${log.user}
                                                ${log.checkStatus ? `(${log.checkStatus === 'IN' ? 'V√ÄO' : 'RA'})` : ''}
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                ${log.method === 'password' ? 'üîë M·∫≠t kh·∫©u' : 'üì° RFID'}: ${log.identifier}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${new Date(log.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('accessLogContent').innerHTML = 
                        `<p class="text-red-600">L·ªói t·∫£i l·ªãch s·ª≠: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error loading access log:', error);
                document.getElementById('accessLogContent').innerHTML = 
                    `<p class="text-red-600">L·ªói k·∫øt n·ªëi: ${error.message}</p>`;
            }
        }

        // =================== REGISTRATION ===================
        async function startRegistration() {
            const fullName = document.getElementById('fullName').value.trim();
            
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'start_registration',
                        userData: fullName ? { fullName } : null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show status and start monitoring
                    document.getElementById('registration').classList.add('hidden');
                    document.getElementById('registrationStatus').classList.remove('hidden');
                    
                    document.getElementById('statusMessage').textContent = 'ƒêƒÉng k√Ω ƒë√£ b·∫Øt ƒë·∫ßu!';
                    document.getElementById('statusDetail').textContent = 'ESP32 s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô nh·∫≠p m·∫≠t kh·∫©u...';
                    
                    // Start checking status every 2 seconds
                    registrationTimer = setInterval(checkRegistrationStatus, 2000);
                    
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error starting registration:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function checkRegistrationStatus() {
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                const response = await fetch(ADMIN_API);
                const data = await response.json();

                if (!data.isActive) {
                    // ƒêƒÉng k√Ω ho√†n t·∫•t ho·∫∑c b·ªã h·ªßy
                    clearInterval(registrationTimer);
                    registrationTimer = null;
                    
                    document.getElementById('statusMessage').textContent = 'ƒêƒÉng k√Ω ho√†n t·∫•t!';
                    document.getElementById('statusDetail').textContent = 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng';
                    
                    setTimeout(() => {
                        document.getElementById('fullName').value = '';
                        showMainMenu();
                    }, 3000);
                    
                } else if (data.step === 'password_set') {
                    document.getElementById('statusMessage').textContent = 'M·∫≠t kh·∫©u ƒë√£ nh·∫≠n';
                    document.getElementById('statusDetail').textContent = 'Qu√©t th·∫ª RFID ho·∫∑c ch·ªù ho√†n t·∫•t t·ª± ƒë·ªông...';
                    
                } else if (data.step === 'password_input') {
                    document.getElementById('statusMessage').textContent = 'Ch·ªù nh·∫≠p m·∫≠t kh·∫©u';
                    document.getElementById('statusDetail').textContent = 'Nh·∫≠p 4 s·ªë tr√™n KeyPad ESP32';
                }
                
            } catch (error) {
                console.error('Error checking registration status:', error);
            }
        }

        async function cancelRegistration() {
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'cancel_registration' })
                });
                
                if (registrationTimer) {
                    clearInterval(registrationTimer);
                    registrationTimer = null;
                }
                
                document.getElementById('registrationStatus').classList.add('hidden');
                showMainMenu();
                
            } catch (error) {
                console.error('Error canceling registration:', error);
            }
        }

        // =================== ADD CARD ===================
        async function loadUsersWithoutCards() {
            try {
                // ‚úÖ S·ª¨A: D√πng SMART_LOCK_API
                const response = await fetch(`${SMART_LOCK_API}?action=get_users`);
                const data = await response.json();

                const userSelect = document.getElementById('userSelect');
                
                if (data.success) {
                    // Filter users without cards
                    const usersWithoutCards = data.users.filter(user => !user.uid || user.uid.trim() === '');
                    
                    if (usersWithoutCards.length === 0) {
                        userSelect.innerHTML = '<option value="">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o c·∫ßn th√™m th·∫ª</option>';
                    } else {
                        userSelect.innerHTML = '<option value="">Ch·ªçn ng∆∞·ªùi d√πng...</option>' + 
                            usersWithoutCards.map(user => 
                                `<option value="${user.id}">${user.name}</option>`
                            ).join('');
                    }
                } else {
                    userSelect.innerHTML = '<option value="">L·ªói t·∫£i d·ªØ li·ªáu</option>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('userSelect').innerHTML = '<option value="">L·ªói k·∫øt n·ªëi</option>';
            }
        }

        async function startAddCard() {
            const targetUserId = document.getElementById('userSelect').value;
            
            if (!targetUserId) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng!');
                return;
            }
            
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'start_add_card',
                        targetUserId: parseInt(targetUserId)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show status and start monitoring
                    document.getElementById('addCard').classList.add('hidden');
                    document.getElementById('addCardStatus').classList.remove('hidden');
                    
                    // Start checking status every 2 seconds
                    addCardTimer = setInterval(checkAddCardStatus, 2000);
                    
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu th√™m th·∫ª: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error starting add card:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function checkAddCardStatus() {
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                const response = await fetch(ADMIN_API);
                const data = await response.json();
                
                if (data.step !== 'add_card' || !data.isActive) {
                    // Add card completed or cancelled
                    clearInterval(addCardTimer);
                    addCardTimer = null;
                    
                    document.getElementById('addCardStatus').classList.add('hidden');
                    showMainMenu();
                    
                    // Show success message
                    alert('Th·∫ª ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!');
                }
            } catch (error) {
                console.error('Error checking add card status:', error);
            }
        }

        async function cancelAddCard() {
            try {
                // ‚úÖ S·ª¨A: D√πng ADMIN_API
                await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'cancel_add_card' })
                });
                
                if (addCardTimer) {
                    clearInterval(addCardTimer);
                    addCardTimer = null;
                }
                
                document.getElementById('addCardStatus').classList.add('hidden');
                showMainMenu();
                
            } catch (error) {
                console.error('Error canceling add card:', error);
            }
        }

        // Quick add card function for user list buttons
        async function addCard(userId, userName) {
            if (confirm(`Th√™m th·∫ª RFID cho ${userName}?`)) {
                try {
                    // ‚úÖ S·ª¨A: D√πng ADMIN_API
                    const response = await fetch(ADMIN_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'start_add_card',
                            targetUserId: userId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Ch·∫ø ƒë·ªô th√™m th·∫ª ƒë√£ b·∫Øt ƒë·∫ßu! Qu√©t th·∫ª RFID tr√™n ESP32...');
                        showMainMenu();
                    } else {
                        alert('L·ªói: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('L·ªói k·∫øt n·ªëi: ' + error.message);
                }
            }
        }

        // Initialize on page load
        window.onload = function() {
            console.log('Smart Lock Management System loaded');
            console.log('API Base:', API_BASE);
        };
    </script>
</body>
</html>