<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Lock Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-indigo-800 mb-8">üîê Smart Lock Management</h1>
        
        <!-- Main Menu -->
        <div id="mainMenu" class="bg-white rounded-lg shadow-lg p-6 screen">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="showUserList()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üë• Danh s√°ch ng∆∞·ªùi d√πng
                </button>
                <button onclick="showAccessLog()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üìä L·ªãch s·ª≠ ra v√†o
                </button>
                <button onclick="showRegistration()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    ‚ûï ƒêƒÉng k√Ω ng∆∞·ªùi d√πng m·ªõi
                </button>
                <button onclick="showAddCard()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                    üé´ Th√™m th·∫ª RFID
                </button>
            </div>
            
            <!-- Test Database Connection -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="testDatabaseConnection()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    üîó Test Database Connection
                </button>
                <!-- ‚úÖ TH√äM: Reset State Button -->
                <button onclick="resetState()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    üîÑ Reset State
                </button>
                <div id="connectionResult" class="mt-2 text-sm"></div>
            </div>
        </div>

        <!-- User List -->
        <div id="userList" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üë• Danh s√°ch ng∆∞·ªùi d√πng</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            <div id="userListContent">Loading...</div>
        </div>

        <!-- Access Log -->
        <div id="accessLog" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üìä L·ªãch s·ª≠ ra v√†o</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            <div id="accessLogContent">Loading...</div>
        </div>

        <!-- Registration -->
        <div id="registration" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">‚ûï ƒêƒÉng k√Ω ng∆∞·ªùi d√πng m·ªõi</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒë·∫ßy ƒë·ªß (t√πy ch·ªçn)</label>
                    <input type="text" id="fullName" placeholder="ƒê·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông t·∫°o t√™n" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button onclick="startRegistration()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg">
                    üöÄ B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω
                </button>
            </div>
        </div>

        <!-- Registration Status -->
        <div id="registrationStatus" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-2" id="statusMessage">ƒêang kh·ªüi t·∫°o...</h3>
                <p class="text-gray-600 mb-4" id="statusDetail">Vui l√≤ng ch·ªù...</p>
                <button onclick="cancelRegistration()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    ‚ùå H·ªßy ƒëƒÉng k√Ω
                </button>
            </div>
        </div>

        <!-- Add Card -->
        <div id="addCard" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üé´ Th√™m th·∫ª RFID</h2>
                <button onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    ‚Üê Quay l·∫°i
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªçn ng∆∞·ªùi d√πng</label>
                    <select id="userSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <button onclick="startAddCard()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg">
                    üé´ B·∫Øt ƒë·∫ßu th√™m th·∫ª
                </button>
            </div>
        </div>

        <!-- Add Card Status -->
        <div id="addCardStatus" class="bg-white rounded-lg shadow-lg p-6 hidden screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
                <h3 class="text-lg font-semibold mb-2">Ch·ªù qu√©t th·∫ª RFID</h3>
                <p class="text-gray-600 mb-4">ƒê·∫∑t th·∫ª RFID l√™n ESP32 ƒë·ªÉ qu√©t...</p>
                <button onclick="cancelAddCard()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                    ‚ùå H·ªßy th√™m th·∫ª
                </button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ S·ª¨A: S·ª≠ d·ª•ng URL m·ªõi nh·∫•t t·ª´ console log
        const API_BASE = 'https://api-iot-v2-7c6xmn69k-hiens-projects-d1689d2e.vercel.app';
        const SMART_LOCK_API = API_BASE + '/api/smart-lock';
        const ADMIN_API = API_BASE + '/api/admin';

        let registrationTimer = null;
        let addCardTimer = null;

        // Debug logging
        console.log('üîó API Configuration:');
        console.log('API_BASE:', API_BASE);
        console.log('SMART_LOCK_API:', SMART_LOCK_API);
        console.log('ADMIN_API:', ADMIN_API);
        console.log('Current URL:', window.location.href);

        // ‚úÖ TH√äM: Test CORS tr∆∞·ªõc khi g·ªçi API
        async function testCORS() {
            try {
                console.log('üß™ Testing CORS...');
                const response = await fetch(ADMIN_API, {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                console.log('‚úÖ CORS test response:', response.status);
                console.log('‚úÖ CORS headers:', [...response.headers.entries()]);
                return response.ok;
            } catch (error) {
                console.error('‚ùå CORS test failed:', error);
                return false;
            }
        }

        // ‚úÖ S·ª¨A: Enhanced error handling
        async function startAddCard() {
            const targetUserId = document.getElementById('userSelect').value;
            
            if (!targetUserId) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng!');
                return;
            }
            
            console.log('üé´ Starting add card for user:', targetUserId);
            
            // Test CORS first
            const corsOk = await testCORS();
            if (!corsOk) {
                alert('L·ªói CORS: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API server');
                return;
            }
            
            try {
                console.log('üì§ Sending add card request...');
                console.log('üîó URL:', ADMIN_API);
                console.log('üìã Payload:', JSON.stringify({ 
                    action: 'start_add_card',
                    targetUserId: parseInt(targetUserId)
                }));
                
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({ 
                        action: 'start_add_card',
                        targetUserId: parseInt(targetUserId)
                    })
                });
                
                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Add card response:', data);
                
                if (data.success) {
                    document.getElementById('addCard').classList.add('hidden');
                    document.getElementById('addCardStatus').classList.remove('hidden');
                    
                    addCardTimer = setInterval(checkAddCardStatus, 2000);
                    
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu th√™m th·∫ª: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('‚ùå Error starting add card:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                let errorMessage = 'L·ªói k·∫øt n·ªëi API: ';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage += 'CORS ho·∫∑c network error. Ki·ªÉm tra:\n';
                    errorMessage += '1. API server c√≥ ho·∫°t ƒë·ªông\n';
                    errorMessage += '2. CORS configuration\n';
                    errorMessage += '3. Network connectivity';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }

        // ‚úÖ S·ª¨A: Enhanced startRegistration v·ªõi CORS test
        async function startRegistration() {
            const fullNameInput = document.getElementById('fullName');
            const fullName = fullNameInput ? fullNameInput.value.trim() : '';
            
            if (!fullName) {
                alert('Vui l√≤ng nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß!');
                return;
            }

            console.log('üöÄ Starting registration for:', fullName);
            
            // Test CORS first
            const corsOk = await testCORS();
            if (!corsOk) {
                alert('L·ªói CORS: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API server');
                return;
            }
            
            try {
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({ 
                        action: 'start_registration',
                        userData: { fullName: fullName }
                    })
                });
                
                console.log('üì• Registration response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Registration HTTP error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Registration response:', data);
                
                if (data.success) {
                    document.getElementById('registration').classList.add('hidden');
                    document.getElementById('registrationStatus').classList.remove('hidden');
                    
                    document.getElementById('statusMessage').textContent = 'ƒêƒÉng k√Ω ƒë√£ b·∫Øt ƒë·∫ßu!';
                    document.getElementById('statusDetail').textContent = 'ESP32 s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô nh·∫≠p m·∫≠t kh·∫©u...';
                    
                    registrationTimer = setInterval(checkRegistrationStatus, 2000);
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        // =================== HELPER FUNCTIONS ===================
        function generateUserListHTML(users) {
            console.log('üîß generateUserListHTML called with:', users);
            console.log('üîß users type:', typeof users);
            console.log('üîß users length:', users ? users.length : 'null/undefined');
            
            if (!users || !Array.isArray(users) || users.length === 0) {
                console.log('üîß No users, returning empty message');
                return '<p class="text-gray-500">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o.</p>';
            }
            
            console.log('üîß Processing', users.length, 'users');
            
            let html = `<h3 class="text-lg font-semibold mb-4">Danh s√°ch ng∆∞·ªùi d√πng (${users.length})</h3><div class="space-y-2">`;
            
            users.forEach((user, index) => {
                console.log(`üîß Processing user ${index}:`, user);
                const safeName = (user.name || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                html += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">${user.name || 'Unknown'}</div>
                                <div class="text-sm text-gray-600">
                                    ID: ${user.id} | 
                                    ${user.uid ? `üé´ Th·∫ª: ${user.uid}` : `üìù Ch∆∞a c√≥ th·∫ª RFID`} |
                                    ${user.hasPassword ? 'üîë C√≥ m·∫≠t kh·∫©u' : '‚ùå Ch∆∞a c√≥ m·∫≠t kh·∫©u'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    T·∫°o: ${user.createdAt ? new Date(user.createdAt).toLocaleString() : 'N/A'}
                                </div>
                            </div>
                            ${!user.uid ? `<button onclick="addCard(${user.id}, '${safeName}')" class="text-blue-600 hover:text-blue-800 text-sm">+ Th√™m th·∫ª</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('userListContent').classList.remove('hidden');
            console.log('üîß Generated HTML length:', html.length);
            return html;
        }

        // =================== NAVIGATION ===================
        function showMainMenu() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('mainMenu').classList.remove('hidden');
        }

        function showUserList() {
            console.log('‚ö°Ô∏è showUserList called');
    
            // Ch·ªâ ·∫©n c√°c m√†n h√¨nh, KH√îNG ·∫©n c√°c th·∫ª con!
            document.querySelectorAll('.screen').forEach(div => div.classList.add('hidden'));
            
            document.getElementById('userList').classList.remove('hidden');
            
            loadUserList();
        }

        function showAccessLog() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('accessLog').classList.remove('hidden');
            loadAccessLog();
        }

        function showRegistration() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('registration').classList.remove('hidden');
        }

        function showAddCard() {
            document.querySelectorAll('div[id]').forEach(div => div.classList.add('hidden'));
            document.getElementById('addCard').classList.remove('hidden');
            loadUsersWithoutCards();
        }

        // =================== DATABASE TEST ===================
        async function testDatabaseConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = 'üîÑ Testing connection...';
            
            try {
                const testUrl = `${SMART_LOCK_API}?action=test_connection`;
                console.log('üîó Testing:', testUrl);
                
                const response = await fetch(testUrl);
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì• Response data:', data);
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="text-green-600">
                            ‚úÖ Database connected!<br>
                            <small>${new Date(data.timestamp).toLocaleString()}</small><br>
                            <small>${data.pgVersion}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="text-red-600">‚ùå Failed: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Database test error:', error);
                resultDiv.innerHTML = `<div class="text-red-600">‚ùå Error: ${error.message}</div>`;
            }
        }

        // =================== USER LIST ===================
        async function loadUserList() {
                console.log('üìã Loading user list...');
    
                try {
                    const url = `${SMART_LOCK_API}?action=get_users`;
                    console.log('üì° Fetching:', url);
                    
                    const response = await fetch(url);
                    console.log('üì• Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Response error:', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• Response data:', data);
                    console.log('üì• Users array:', data.users);
                    console.log('üì• Users type:', typeof data.users);
                    console.log('üì• Users length:', data.users ? data.users.length : 'undefined');
                    console.log('üìä FULL API RESPONSE:', JSON.stringify(data));
                    console.log('üìä User object structure:', 
                        data.users && data.users[0] ? Object.keys(data.users[0]) : 'No users');

                    const content = document.getElementById('userListContent');
                    
                    if (data.success && data.users) {
                        console.log('‚úÖ Generating HTML for', data.users.length, 'users');
                        console.log('‚úÖ First user:', data.users[0]);
                        
                        const html = generateUserListHTML(data.users);
                        console.log('‚úÖ Generated HTML:', html.substring(0, 200) + '...');
                        
                        content.innerHTML = html;
                        console.log('‚úÖ HTML inserted into DOM');
                        console.log('‚úÖ Content element innerHTML length:', content.innerHTML.length);
                    } else {
                        console.log('‚ùå No users data or success=false');
                        content.innerHTML = `<p class="text-red-600">L·ªói: ${data.error || 'No users found'}</p>`;
                    }

                } catch (error) {
                    console.error('‚ùå Error loading user list:', error);
                    document.getElementById('userListContent').innerHTML = 
                        `<p class="text-red-600">L·ªói k·∫øt n·ªëi: ${error.message}</p>`;
                }
            }

        // =================== ACCESS LOG ===================
        async function loadAccessLog() {
            console.log('üìä Loading access log...');
            
            try {
                const url = `${SMART_LOCK_API}?action=get_access_log&limit=30`;
                console.log('üì° Fetching:', url);
                
                const response = await fetch(url);
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('üì• Response data:', data);

                if (data.success) {
                    const content = document.getElementById('accessLogContent');
                    
                    if (data.logs.length === 0) {
                        content.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ truy c·∫≠p n√†o.</p>';
                        return;
                    }
                    
                    content.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4">L·ªãch s·ª≠ truy c·∫≠p (${data.logs.length})</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${data.logs.map(log => `
                                <div class="bg-gray-50 p-3 rounded-lg border-l-4 ${log.success ? 'border-green-500' : 'border-red-500'}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-medium">
                                                ${log.success ? '‚úÖ' : '‚ùå'} ${log.user}
                                                ${log.checkStatus ? `(${log.checkStatus === 'IN' ? 'V√ÄO' : 'RA'})` : ''}
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                ${log.method === 'password' ? 'üîë M·∫≠t kh·∫©u' : 'üì° RFID'}: ${log.identifier}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${new Date(log.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('accessLogContent').innerHTML = 
                        `<p class="text-red-600">L·ªói t·∫£i l·ªãch s·ª≠: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error loading access log:', error);
                document.getElementById('accessLogContent').innerHTML = 
                    `<p class="text-red-600">L·ªói k·∫øt n·ªëi: ${error.message}</p>`;
            }
        }

        // =================== REGISTRATION ===================
        async function startRegistration() {
            const fullName = document.getElementById('fullName').value.trim();
            
            try {
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'start_registration',
                        userData: fullName ? { fullName } : null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('registration').classList.add('hidden');
                    document.getElementById('registrationStatus').classList.remove('hidden');
                    
                    document.getElementById('statusMessage').textContent = 'ƒêƒÉng k√Ω ƒë√£ b·∫Øt ƒë·∫ßu!';
                    document.getElementById('statusDetail').textContent = 'ESP32 s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô nh·∫≠p m·∫≠t kh·∫©u...';
                    
                    registrationTimer = setInterval(checkRegistrationStatus, 2000);
                    
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error starting registration:', error);
                alert('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        }

        async function checkRegistrationStatus() {
            try {
                const response = await fetch(ADMIN_API);
                const data = await response.json();

                if (!data.isActive) {
                    clearInterval(registrationTimer);
                    registrationTimer = null;
                    
                    document.getElementById('statusMessage').textContent = 'ƒêƒÉng k√Ω ho√†n t·∫•t!';
                    document.getElementById('statusDetail').textContent = 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng';
                    
                    setTimeout(() => {
                        document.getElementById('fullName').value = '';
                        showMainMenu();
                    }, 3000);
                    
                } else if (data.step === 'password_set') {
                    document.getElementById('statusMessage').textContent = 'M·∫≠t kh·∫©u ƒë√£ nh·∫≠n';
                    document.getElementById('statusDetail').textContent = 'Qu√©t th·∫ª RFID ho·∫∑c ch·ªù ho√†n t·∫•t t·ª± ƒë·ªông...';
                    
                } else if (data.step === 'password_input') {
                    document.getElementById('statusMessage').textContent = 'Ch·ªù nh·∫≠p m·∫≠t kh·∫©u';
                    document.getElementById('statusDetail').textContent = 'Nh·∫≠p 4 s·ªë tr√™n KeyPad ESP32';
                }
                
            } catch (error) {
                console.error('Error checking registration status:', error);
            }
        }

        async function cancelRegistration() {
            try {
                await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'cancel_registration' })
                });
                
                if (registrationTimer) {
                    clearInterval(registrationTimer);
                    registrationTimer = null;
                }
                
                document.getElementById('registrationStatus').classList.add('hidden');
                showMainMenu();
                
            } catch (error) {
                console.error('Error canceling registration:', error);
            }
        }
        // =================== RESET STATE ===================
        async function resetState() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset state? ƒêi·ªÅu n√†y s·∫Ω h·ªßy t·∫•t c·∫£ c√°c ho·∫°t ƒë·ªông ƒëang th·ª±c hi·ªán.')) {
                return;
            }
            
            try {
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset_state' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('connectionResult').innerHTML = 
                        '<div class="text-green-600">‚úÖ State reset th√†nh c√¥ng!</div>';
                } else {
                    document.getElementById('connectionResult').innerHTML = 
                        '<div class="text-red-600">‚ùå Reset th·∫•t b·∫°i: ' + (data.error || 'Unknown error') + '</div>';
                }
            } catch (error) {
                document.getElementById('connectionResult').innerHTML = 
                    '<div class="text-red-600">‚ùå L·ªói k·∫øt n·ªëi: ' + error.message + '</div>';
            }
        }
        // =================== ADD CARD ===================
        async function loadUsersWithoutCards() {
            try {
                const response = await fetch(`${SMART_LOCK_API}?action=get_users`);
                const data = await response.json();

                const userSelect = document.getElementById('userSelect');
                
                if (data.success) {
                    const usersWithoutCards = data.users.filter(user => !user.uid || user.uid.trim() === '');
                    
                    if (usersWithoutCards.length === 0) {
                        userSelect.innerHTML = '<option value="">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o c·∫ßn th√™m th·∫ª</option>';
                    } else {
                        userSelect.innerHTML = '<option value="">Ch·ªçn ng∆∞·ªùi d√πng...</option>' + 
                            usersWithoutCards.map(user => 
                                `<option value="${user.id}">${user.name}</option>`
                            ).join('');
                    }
                } else {
                    userSelect.innerHTML = '<option value="">L·ªói t·∫£i d·ªØ li·ªáu</option>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('userSelect').innerHTML = '<option value="">L·ªói k·∫øt n·ªëi</option>';
            }
        }

        async function startAddCard() {
            const targetUserId = document.getElementById('userSelect').value;
            
            if (!targetUserId) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi d√πng!');
                return;
            }
            
            console.log('üé´ Starting add card for user:', targetUserId);
            
            // Test CORS first
            const corsOk = await testCORS();
            if (!corsOk) {
                alert('L·ªói CORS: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API server');
                return;
            }
            
            try {
                console.log('üì§ Sending add card request...');
                console.log('üîó URL:', ADMIN_API);
                console.log('üìã Payload:', JSON.stringify({ 
                    action: 'start_add_card',
                    targetUserId: parseInt(targetUserId)
                }));
                
                const response = await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({ 
                        action: 'start_add_card',
                        targetUserId: parseInt(targetUserId)
                    })
                });
                
                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Add card response:', data);
                
                if (data.success) {
                    document.getElementById('addCard').classList.add('hidden');
                    document.getElementById('addCardStatus').classList.remove('hidden');
                    
                    addCardTimer = setInterval(checkAddCardStatus, 2000);
                    
                } else {
                    alert('L·ªói b·∫Øt ƒë·∫ßu th√™m th·∫ª: ' + (data.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('‚ùå Error starting add card:', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                
                let errorMessage = 'L·ªói k·∫øt n·ªëi API: ';
                
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage += 'CORS ho·∫∑c network error. Ki·ªÉm tra:\n';
                    errorMessage += '1. API server c√≥ ho·∫°t ƒë·ªông\n';
                    errorMessage += '2. CORS configuration\n';
                    errorMessage += '3. Network connectivity';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }

        async function checkAddCardStatus() {
            try {
                const response = await fetch(ADMIN_API);
                const data = await response.json();
                
                if (data.step !== 'add_card' || !data.isActive) {
                    clearInterval(addCardTimer);
                    addCardTimer = null;
                    
                    document.getElementById('addCardStatus').classList.add('hidden');
                    showMainMenu();
                    
                    alert('Th·∫ª ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!');
                }
            } catch (error) {
                console.error('Error checking add card status:', error);
            }
        }

        async function cancelAddCard() {
            try {
                await fetch(ADMIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'cancel_add_card' })
                });
                
                if (addCardTimer) {
                    clearInterval(addCardTimer);
                    addCardTimer = null;
                }
                
                document.getElementById('addCardStatus').classList.add('hidden');
                showMainMenu();
                
            } catch (error) {
                console.error('Error canceling add card:', error);
            }
        }

        async function addCard(userId, userName) {
            if (confirm(`Th√™m th·∫ª RFID cho ${userName}?`)) {
                try {
                    const response = await fetch(ADMIN_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'start_add_card',
                            targetUserId: userId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Ch·∫ø ƒë·ªô th√™m th·∫ª ƒë√£ b·∫Øt ƒë·∫ßu! Qu√©t th·∫ª RFID tr√™n ESP32...');
                        showMainMenu();
                    } else {
                        alert('L·ªói: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('L·ªói k·∫øt n·ªëi: ' + error.message);
                }
            }
        }

        // Initialize on page load
        window.onload = function() {
            console.log('üöÄ Smart Lock Management System loaded');
            console.log('‚úÖ API Base:', API_BASE);
            console.log('‚úÖ Current URL:', window.location.href);
        };
    </script>
</body>
</html>